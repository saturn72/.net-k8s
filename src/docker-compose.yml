version: '3.4'

services:
  reverse-proxy:
    image: traefik:v2.6
    container_name: traefik
    ports:
    - "81:80"
    - "443:443"
    - "8080:8080"
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - ./traefik.yml:/etc/traefik/traefik.yml

  firebase:
    image: ehealthafrica/firebase-emulator:latest
    build: .

    volumes:
      - ./firebase/emulators/:/opt/workspace:cached
      - ./firebase/bin/:/root/.cache:cached
      - ./firebase/config/:/root/.config:cached
    ports:
      - 4000:4000 # Emulator Suite UI
      - 5000:5000 # Firebase Hosting
      - 5001:5001 # Clound Functions
      - 9000:9000 # Realtime Database
      - 8080:8080 # Cloud Firestore
      - 8085:8085 # Cloud Pub/Sub
    working_dir: /opt/workspace
    networks:
      - backend
    command: bash
    tty: true

  rabbitmq:
    image: rabbitmq:3-management-alpine

  identity:
    image: ${DOCKER_REGISTRY-}identity
    container_name: identity
    ports:
    - "5010:80"
    - "5011:443"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.identity.rule=Host(`identity`)"
      - "traefik.http.routers.identity.service=identity"
      - "traefik.http.routers.identity.entrypoints=websecure"
      # - "traefik.http.services.identity.loadbalancer.servers.url=http://identity"
      - "traefik.http.routers.identity.tls=true"
      - "traefik.http.services.identity.loadbalancer.server.port=5010"
    build:
      context: .
      dockerfile: Infrastructure/IdentityServer/Dockerfile
  
  endpoint-query:
    build:
      context: .
      dockerfile: Services/EndpointQueryService/Dockerfile
    depends_on:
      - identity
      - firebase
      - rabbitmq