version: '3.4'

services:
  reverse-proxy:
    image: traefik:v2.6
    container_name: traefik
    ports:
    - "81:80"
    - "443:443"
    - "8080:8080"
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - ./traefik.yml:/etc/traefik/traefik.yml

  rabbitmq:
    image: rabbitmq:3-management-alpine

  identity:
    image: ${DOCKER_REGISTRY-}identity
    container_name: identity
    ports:
    - "5010:80"
    - "5011:443"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.identity.rule=Host(`identity`)"
      - "traefik.http.routers.identity.service=identity"
      - "traefik.http.routers.identity.entrypoints=websecure"
      # - "traefik.http.services.identity.loadbalancer.servers.url=http://identity"
      - "traefik.http.routers.identity.tls=true"
      - "traefik.http.services.identity.loadbalancer.server.port=5010"
    build:
      context: .
      dockerfile: Infrastructure/IdentityServer/Dockerfile
  
  endpoint-query:
    build:
      context: .
      dockerfile: Services/EndpointQueryService/Dockerfile
    depends_on:
      - identity
      - rabbitmq